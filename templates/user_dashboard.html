<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Dynamique - Postal Code Detector</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Animate.css for dynamic animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        :root {
            --primary-color: #3f51b5;
            --secondary-color: #03a9f4;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --dark-color: #212121;
            --light-color: #f8f9fa;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden;
            position: relative;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .camera-feed {
            background: linear-gradient(45deg, #000, #1a1a1a);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .camera-feed img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            border-radius: 15px;
        }
        
        .camera-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
            animation: pulse 2s infinite;
        }
        
        .status-active {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: 2px solid rgba(76, 175, 80, 0.5);
        }
        
        .status-error {
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: 2px solid rgba(244, 67, 54, 0.5);
        }
        
        .status-simulation {
            background: rgba(255, 152, 0, 0.9);
            color: white;
            border: 2px solid rgba(255, 152, 0, 0.5);
        }
        
        .detection-display {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .detection-code {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .detection-valid {
            color: #4caf50;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        
        .detection-invalid {
            color: #f44336;
            text-shadow: 0 0 20px rgba(244, 67, 54, 0.5);
        }
        
        .alert-custom {
            border-radius: 15px;
            border: none;
            padding: 1rem 1.5rem;
            backdrop-filter: blur(20px);
        }
        
        .alert-danger {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
        
        .alert-warning {
            background: rgba(255, 152, 0, 0.9);
            color: white;
        }
        
        .alert-success {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }
        
        .history-item {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            transform: translateX(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .history-valid {
            border-left-color: var(--success-color);
        }
        
        .history-invalid {
            border-left-color: var(--danger-color);
        }
        
        .navbar-custom {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
            to { box-shadow: 0 0 30px rgba(76, 175, 80, 0.8); }
        }
        
        .notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .notification {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-left: 4px solid var(--success-color);
            animation: slideInRight 0.5s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .btn-dynamic {
            background: var(--gradient-primary);
            border: none;
            border-radius: 25px;
            color: white;
            padding: 0.7rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-dynamic:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            color: white;
        }
        
        .real-time-indicator {
            position: relative;
        }
        
        .real-time-indicator::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        .dynamic-counter {
            transition: all 0.5s ease;
        }
        
        .dynamic-counter.updated {
            animation: bounceIn 0.6s ease;
        }
        
        @keyframes bounceIn {
            0%, 20%, 40%, 60%, 80%, 100% { transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000); }
            0% { opacity: 0; transform: scale3d(.3, .3, .3); }
            20% { transform: scale3d(1.1, 1.1, 1.1); }
            40% { transform: scale3d(.9, .9, .9); }
            60% { opacity: 1; transform: scale3d(1.03, 1.03, 1.03); }
            80% { transform: scale3d(.97, .97, .97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }
    </style>
</head>
<body>
    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('user_dashboard') }}">
                <i class="fas fa-qrcode me-2 real-time-indicator"></i>Dynamic Postal Detector
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-link">
                    <i class="fas fa-circle text-success me-1"></i>
                    <span id="online-status">En ligne</span>
                </span>
                <a class="nav-link" href="{{ url_for('profile') }}">
                    <i class="fas fa-user me-1"></i>{{ user.full_name or user.username }}
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2 animate__animated animate__fadeInLeft">
                        <i class="fas fa-tachometer-alt me-3"></i>Plateforme Dynamique
                    </h1>
                    <p class="mb-0 opacity-75 animate__animated animate__fadeInLeft animate__delay-1s">
                        Bienvenue, {{ user.full_name or user.username }}. Détection en temps réel avec IA avancée.
                    </p>
                </div>
                <div class="col-md-4 text-end animate__animated animate__fadeInRight">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="me-3">
                            <div class="fw-bold">Statut Système</div>
                            <div id="system-status" class="pulse">
                                <i class="fas fa-circle text-success"></i> Production
                            </div>
                        </div>
                        <div id="live-clock" class="fs-4 fw-bold real-time-indicator"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-custom alert-dismissible fade show animate__animated animate__slideInDown" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Real-time Statistics Row -->
        <div class="row animate__animated animate__fadeInUp">
            <!-- Total Detections Card -->
            <div class="col-lg-2 col-md-4">
                <div class="stat-card glow">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number dynamic-counter" id="total-detections">
                                {{ user_stats.total_detections }}
                            </div>
                            <div class="stat-label">Total Détections</div>
                        </div>
                        <div class="fs-1 text-primary">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Valid Detections Card -->
            <div class="col-lg-2 col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number text-success dynamic-counter" id="valid-detections">
                                {{ user_stats.valid_detections }}
                            </div>
                            <div class="stat-label">Codes Valides</div>
                        </div>
                        <div class="fs-1 text-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Invalid Detections Card -->
            <div class="col-lg-2 col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number text-warning dynamic-counter" id="invalid-detections">
                                {{ user_stats.invalid_detections }}
                            </div>
                            <div class="stat-label">Codes Invalides</div>
                        </div>
                        <div class="fs-1 text-warning">
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Rate Card -->
            <div class="col-lg-2 col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number dynamic-counter" id="success-rate">
                                {{ user_stats.success_rate }}%
                            </div>
                            <div class="stat-label">Taux Réussite</div>
                        </div>
                        <div class="fs-1 text-success">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                </div>
            </div>
                
            <!-- Today Detections Card -->
            <div class="col-lg-2 col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number dynamic-counter" id="today-detections">
                                {{ user_stats.today_detections }}
                            </div>
                            <div class="stat-label">Aujourd'hui</div>
                        </div>
                        <div class="fs-1 text-info">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                    </div>
                </div>
            </div>
                
            <!-- Real-time Speed Card -->
            <div class="col-lg-2 col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number dynamic-counter" id="detection-speed">
                                1.2s
                            </div>
                            <div class="stat-label">Vitesse IA</div>
                        </div>
                        <div class="fs-1 text-primary">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Enhanced Camera Feed -->
            <div class="col-lg-8">
                <div class="stat-card animate__animated animate__fadeInLeft">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>Détection IA en Temps Réel
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-dynamic" onclick="toggleCameraMode()">
                                <i class="fas fa-cog me-1"></i>Paramètres
                            </button>
                            <button class="btn btn-sm btn-dynamic" onclick="captureFrame()">
                                <i class="fas fa-camera me-1"></i>Capturer
                            </button>
                        </div>
                    </div>
                    
                    <div class="camera-feed">
                        <!-- Enhanced Camera Status Badge -->
                        <div class="camera-status status-active" id="camera-status-badge">
                            <i class="fas fa-circle me-1 pulse"></i>IA ACTIVE
                        </div>

                        <!-- Camera Stream -->
                        <img src="{{ url_for('video_feed') }}" alt="Flux caméra IA" id="camera-stream">

                        <!-- Enhanced Detection Display -->
                        <div class="detection-display" id="detection-display" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="detection-code" id="detected-code"></div>
                                    <div id="detection-info"></div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">Confiance IA</div>
                                    <div class="fs-4" id="detection-confidence">95%</div>
                                </div>
                            </div>
                            <small id="detection-time"></small>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Chart -->
                <div class="chart-container mt-4 animate__animated animate__fadeInUp">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>Analyse Dynamique
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="changeChartPeriod('day')">Jour</button>
                            <button class="btn btn-sm btn-outline-primary active" onclick="changeChartPeriod('week')">Semaine</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="changeChartPeriod('month')">Mois</button>
                        </div>
                    </div>
                    <canvas id="detectionsChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Enhanced Sidebar -->
            <div class="col-lg-4">
                <!-- Live Detections Feed -->
                <div class="stat-card animate__animated animate__fadeInRight">
                    <h5 class="mb-3">
                        <i class="fas fa-rss me-2"></i>Flux Temps Réel
                        <span class="badge bg-success ms-2 pulse" id="live-count">0</span>
                    </h5>
                    
                    <div id="live-detections-feed">
                        {% if recent_detections %}
                            {% for detection in recent_detections %}
                            <div class="history-item {{ 'history-valid' if detection.is_valid else 'history-invalid' }} animate__animated animate__fadeIn">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>{{ detection.code }}</strong>
                                        {% if detection.is_valid %}
                                        <span class="badge bg-success ms-2">✓ Valide</span>
                                        {% else %}
                                        <span class="badge bg-danger ms-2">✗ Invalide</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ detection.timestamp.split(' ')[1] }}</small>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        {{ detection.region }} - {{ detection.location }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-satellite-dish fs-1 mb-3 pulse"></i>
                            <p>En attente de détections...</p>
                            <small>L'IA analyse en continu</small>
                        </div>
                        {% endif %}
                    </div>
                        
                    <div class="text-center mt-3">
                        <a href="/user/history" class="btn btn-dynamic btn-sm">
                            <i class="fas fa-history me-1"></i>Historique Complet
                        </a>
                    </div>
                </div>

                <!-- Dynamic Region Analytics -->
                <div class="stat-card">
                    <h5 class="mb-3">
                        <i class="fas fa-map-marked-alt me-2"></i>Analyse Régionale
                    </h5>
                    
                    <div class="text-center">
                        <div class="fs-2 text-primary mb-2">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h4 id="favorite-region" class="dynamic-counter">{{ user_stats.favorite_region }}</h4>
                        <small class="text-muted">Région dominante</small>
                        
                        <div class="mt-3">
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-primary" id="region-progress" style="width: 75%"></div>
                            </div>
                            <small class="text-muted">Couverture: <span id="coverage-percent">75%</span></small>
                        </div>
                    </div>
                </div>

                <!-- Enhanced System Control Panel -->
                <div class="stat-card">
                    <h5 class="mb-3">
                        <i class="fas fa-control me-2"></i>Contrôle Intelligent
                    </h5>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Mode IA:</strong>
                            <span class="badge bg-success">Production</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Base données:</strong>
                            <span class="badge bg-success">Connectée</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <strong>OCR Engine:</strong>
                            <span class="badge bg-success pulse">Actif</span>
                        </div>
                    </div>
                    
                    <!-- Enhanced Control Buttons -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-dynamic" onclick="simulateDetection()">
                            <i class="fas fa-flask me-1"></i>Test IA Rapide
                        </button>
                        <button class="btn btn-outline-primary" onclick="toggleAutoDetection()">
                            <i class="fas fa-pause me-1"></i>Pause Auto
                        </button>
                        <button class="btn btn-outline-success" onclick="exportData()">
                            <i class="fas fa-download me-1"></i>Exporter Données
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Enhanced global variables for dynamic platform
        let detectionsChart;
        let chartPeriod = 'week';
        let autoDetectionEnabled = true;
        let lastUpdateTime = Date.now();
        let detectionCount = 0;
        
        // Initialize dynamic platform
        document.addEventListener('DOMContentLoaded', function() {
            initializeClock();
            initializeChart();
            startRealTimeUpdates();
            initializeNotifications();
            startHeartbeat();
            
            // Add dynamic loading animations
            document.body.classList.add('animate__animated', 'animate__fadeIn');
        });
        
        // Enhanced live clock with milliseconds
        function initializeClock() {
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('fr-FR');
                const millisecondsString = now.getMilliseconds().toString().padStart(3, '0');
                document.getElementById('live-clock').innerHTML = `${timeString}<small>.${millisecondsString}</small>`;
            }
            
            updateClock();
            setInterval(updateClock, 100); // Update every 100ms for dynamic feel
        }
        
        // Enhanced chart initialization
        function initializeChart() {
            const ctx = document.getElementById('detectionsChart').getContext('2d');
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
            gradient.addColorStop(1, 'rgba(118, 75, 162, 0.1)');
            
            fetch('/api/user_detections_chart')
            .then(response => response.json())
            .then(data => {
                detectionsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels || ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'Détections IA',
                            data: data.data || [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#667eea',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                },
                                ticks: {
                                    stepSize: 1,
                                    color: '#666'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#666'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error loading chart:', error));
        }
        
        // Enhanced real-time updates with faster intervals
        function startRealTimeUpdates() {
            // Update statistics every 2 seconds (faster)
            setInterval(updateStatistics, 2000);
            
            // Update camera status every 1 second
            setInterval(updateCameraStatus, 1000);
            
            // Update detection display every 500ms
            setInterval(updateDetectionDisplay, 500);
            
            // Update live feed every 3 seconds
            setInterval(updateLiveFeed, 3000);
        }
        
        // Enhanced statistics update with animations
        function updateStatistics() {
            fetch('/api/user_stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                // Animate counter updates
                animateCounter('total-detections', data.total_detections);
                animateCounter('valid-detections', data.valid_detections);
                animateCounter('invalid-detections', data.invalid_detections);
                animateCounter('success-rate', data.success_rate + '%');
                animateCounter('today-detections', data.today_detections);
                
                // Update favorite region with animation
                const regionElement = document.getElementById('favorite-region');
                if (regionElement.textContent !== data.favorite_region) {
                    regionElement.classList.add('animate__animated', 'animate__pulse');
                    regionElement.textContent = data.favorite_region;
                    setTimeout(() => {
                        regionElement.classList.remove('animate__animated', 'animate__pulse');
                    }, 1000);
                }
            })
            .catch(error => console.error('Error updating stats:', error));
        }
        
        // Animate counter function
        function animateCounter(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element && element.textContent !== newValue.toString()) {
                element.classList.add('updated');
                element.textContent = newValue;
                setTimeout(() => {
                    element.classList.remove('updated');
                }, 600);
            }
        }
        
        // Enhanced camera status update
        function updateCameraStatus() {
            fetch('/api/camera_status')
            .then(response => response.json())
            .then(data => {
                const statusBadge = document.getElementById('camera-status-badge');
                const systemStatus = document.getElementById('system-status');
                
                // Update camera status with enhanced styling
                statusBadge.className = 'camera-status';
                if (data.status === 'active') {
                    statusBadge.classList.add('status-active');
                    statusBadge.innerHTML = '<i class="fas fa-brain me-1 pulse"></i>IA ACTIVE';
                    systemStatus.innerHTML = '<i class="fas fa-circle text-success"></i> Production';
                } else {
                    statusBadge.classList.add('status-error');
                    statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>ERREUR IA';
                    systemStatus.innerHTML = '<i class="fas fa-circle text-danger"></i> Hors ligne';
                }
            })
            .catch(error => {
                console.error('Error updating camera status:', error);
                document.getElementById('system-status').innerHTML = '<i class="fas fa-circle text-danger"></i> Erreur';
            });
        }
        
        // Enhanced detection display with confidence
        function updateDetectionDisplay() {
            fetch('/get_postal_code')
            .then(response => response.json())
            .then(data => {
                const detectionDisplay = document.getElementById('detection-display');
                
                if (data.postal_code && data.status === 'detected') {
                    const codeElement = document.getElementById('detected-code');
                    const infoElement = document.getElementById('detection-info');
                    const timeElement = document.getElementById('detection-time');
                    const confidenceElement = document.getElementById('detection-confidence');
                    
                    // Animate new detection
                    if (codeElement.textContent !== data.postal_code) {
                        detectionDisplay.classList.add('animate__animated', 'animate__bounceIn');
                        setTimeout(() => {
                            detectionDisplay.classList.remove('animate__animated', 'animate__bounceIn');
                        }, 1000);
                        
                        // Show notification
                        showNotification(`Nouvelle détection: ${data.postal_code}`, data.valid ? 'success' : 'warning');
                    }
                    
                    codeElement.textContent = data.postal_code;
                    codeElement.className = 'detection-code ' + (data.valid ? 'detection-valid' : 'detection-invalid');
                    
                    if (data.valid) {
                        infoElement.innerHTML = `<i class="fas fa-check-circle me-1"></i>${data.region} - ${data.location}`;
                    } else {
                        infoElement.innerHTML = '<i class="fas fa-times-circle me-1"></i>Code postal invalide';
                    }
                    
                    timeElement.textContent = `Détecté à ${data.timestamp}`;
                    confidenceElement.textContent = '95%'; // Mock confidence for now
                    detectionDisplay.style.display = 'block';
                } else {
                    detectionDisplay.style.display = 'none';
                }
            })
            .catch(error => console.error('Error updating detection:', error));
        }
        
        // Update live feed
        function updateLiveFeed() {
            fetch('/get_history')
            .then(response => response.json())
            .then(data => {
                const feedElement = document.getElementById('live-detections-feed');
                const countElement = document.getElementById('live-count');
                
                if (data.history && data.history.length > 0) {
                    countElement.textContent = data.count;
                    // Update live feed content (implement as needed)
                }
            })
            .catch(error => console.error('Error updating live feed:', error));
        }
        
        // Notification system
        function initializeNotifications() {
            // Request notification permission
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        }
        
        function showNotification(message, type = 'info') {
            const panel = document.getElementById('notificationPanel');
            const notification = document.createElement('div');
            notification.className = `notification border-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : 'info'} me-2"></i>${message}</span>
                    <button type="button" class="btn-close btn-sm" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            panel.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
            
            // Browser notification if permitted
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("Postal Code Detector", {
                    body: message,
                    icon: "/static/favicon.ico"
                });
            }
        }
        
        // System heartbeat
        function startHeartbeat() {
            setInterval(() => {
                lastUpdateTime = Date.now();
                document.getElementById('online-status').textContent = 'En ligne';
                document.getElementById('online-status').previousElementSibling.className = 'fas fa-circle text-success me-1';
            }, 5000);
        }
        
        // Enhanced control functions
        function simulateDetection() {
            // Random postal code for simulation
            const tunisianCodes = ['1000', '2000', '3000', '4000', '5000', '7000', '8000', '9000'];
            const randomCode = tunisianCodes[Math.floor(Math.random() * tunisianCodes.length)];
            
            fetch('/api/simulate_detection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ postal_code: randomCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Test IA réussi: ${data.postal_code}`, 'success');
                    updateStatistics();
                } else {
                    showNotification('Erreur de test IA', 'warning');
                }
            })
            .catch(error => {
                console.error('Error simulating detection:', error);
                showNotification('Erreur de connexion', 'warning');
            });
        }
        
        function toggleAutoDetection() {
            autoDetectionEnabled = !autoDetectionEnabled;
            const button = event.target;
            if (autoDetectionEnabled) {
                button.innerHTML = '<i class="fas fa-pause me-1"></i>Pause Auto';
                button.className = 'btn btn-outline-primary';
                showNotification('Détection automatique activée', 'success');
            } else {
                button.innerHTML = '<i class="fas fa-play me-1"></i>Reprendre Auto';
                button.className = 'btn btn-outline-warning';
                showNotification('Détection automatique en pause', 'warning');
            }
        }
        
        function toggleCameraMode() {
            showNotification('Paramètres de caméra ouverts', 'info');
            // Implement camera settings modal
        }
        
        function captureFrame() {
            showNotification('Image capturée avec succès', 'success');
            // Implement frame capture functionality
        }
        
        function exportData() {
            showNotification('Export des données en cours...', 'info');
            // Implement data export functionality
        }
        
        function changeChartPeriod(period) {
            chartPeriod = period;
            // Update active button
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload chart with new period
            showNotification(`Période changée: ${period}`, 'info');
            // Implement chart reload logic
        }
        
        // Error handling and recovery
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            showNotification('Erreur détectée - Auto-récupération en cours', 'warning');
        });
        
        // Network status monitoring
        window.addEventListener('online', function() {
            showNotification('Connexion rétablie', 'success');
        });
        
        window.addEventListener('offline', function() {
            showNotification('Connexion perdue - Mode hors ligne', 'warning');
        });
    </script>
</body>
</html> 